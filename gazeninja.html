<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gaze-OS Living Room</title>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <style>
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
      font-family: system-ui, sans-serif;
    }
    #calibrationArea {
      position: relative;
      width: 1024px;
      height: 768px;
      margin: auto;
      border: 2px solid #444;
      overflow: hidden;
      background: #000;
    }
    #roomCanvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
    }
    #gazeDot, #gazeDotEMA {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      position: absolute;
      pointer-events: none;
      display: none;
    }
    #gazeDot { background: rgba(255,0,0,.6); z-index: 30; }
    #gazeDotEMA { background: rgba(0,140,255,.7); z-index: 29; }
    .calibration-point {
      width: 18px;
      height: 18px;
      background: #f44336;
      border-radius: 50%;
      position: absolute;
      cursor: pointer;
      z-index: 50;
      transition: transform .15s ease-out;
    }
    button {
      position: absolute;
      bottom: 10px;
      left: 10px;
      padding: 6px 12px;
      font-size: .9rem;
      z-index: 60;
    }
  </style>
</head>
<body>
  <div id="calibrationArea">
    <canvas id="roomCanvas"></canvas>
    <div id="gazeDot"></div>
    <div id="gazeDotEMA"></div>
  </div>
  <button id="calBtn">Start Calibration</button>

  <script>
  // ---- DOM & Canvas Setup ----
  const area    = document.getElementById('calibrationArea');
  const canvas  = document.getElementById('roomCanvas');
  const ctx     = canvas.getContext('2d');
  const gazeDot    = document.getElementById('gazeDot');
  const gazeDotEMA = document.getElementById('gazeDotEMA');
  const calBtn     = document.getElementById('calBtn');

  let areaRect, darkMode = true, lastId = null;
  let emaX = null, emaY = null;
  const ALPHA = 0.20;

  // ---- Furniture Hit-Regions (x,y,w,h) on 1024Ã—768 canvas ----
  const furniture = [
    { id: 'bookshelf',  x:  44,  y: 36, w: 249, h: 526 },
    { id: 'sofa_web',   x: 350,  y: 309, w: 127, h: 124 },
    { id: 'sofa_game',  x: 543,  y: 301, w: 123, h: 124 },
    { id: 'phone',      x: 704,  y: 284, w:  131, h:  125  },
    { id: 'lamp',       x: 812,  y:  87, w:  107, h: 134 },
    { id: 'tv',         x: 842,  y: 275, w: 171, h: 198  },
    // { id: 'rug',        x: 200,  y: 650, w: 600, h: 100 },
    // { id: 'files',     x: 100,  y:  50, w: 200, h: 150 },
    { id: 'files',      x: 500,  y:  465, w:  101, h:  89 },
  ];

  // ---- Load Background Image ----
  const bg = new Image();
  bg.src = 'livingroom.png';
  bg.onload = () => {
    resizeCanvas();
    areaRect = area.getBoundingClientRect();
    draw();
  };

  function resizeCanvas(){
    canvas.width  = area.offsetWidth;
    canvas.height = area.offsetHeight;
    areaRect = area.getBoundingClientRect();
    draw();
  }
  window.addEventListener('resize', resizeCanvas);

  function draw(){
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
    console.log(canvas.width);
    console.log(canvas.height)
    
    if(darkMode){
      ctx.fillStyle = 'rgba(0,0,0,0.6)';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }
  }

  // ---- Highlight & Label ----
  function highlightAt(x,y){
    const hit = furniture.find(f =>
      x >= f.x && x <= f.x + f.w &&
      y >= f.y && y <= f.y + f.h
    );

    if(!hit){
      if(lastId){
        lastId = null;
        draw();
      }
      return;
    }

    if(hit.id !== lastId){
      // special: toggle dark/bright on lamp
      if(hit.id === 'lamp'){
        toggleDarkMode();
      }
      lastId = hit.id;
      draw();

      if(hit.id !== 'lamp'){
        // glow overlay
        ctx.save();
        ctx.beginPath();
        ctx.rect(hit.x, hit.y, hit.w, hit.h);
        ctx.fillStyle = 'rgba(255,255,200,0.4)';
        ctx.fill();
        ctx.restore();

        // label
        showLabel(hit.id, hit.x + hit.w/2, hit.y - 10);
      }
    }
  }

  function showLabel(id, x, y){
    const label = id.replace('_',' ').toUpperCase();
    ctx.save();
    ctx.font = '18px sans-serif';
    ctx.fillStyle = 'white';
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    ctx.strokeText(label, x - 40, y);
    ctx.fillText(label, x - 40, y);
    ctx.restore();
  }

  function toggleDarkMode(){
    darkMode = !darkMode;
    draw();
  }

  // ---- Calibration (unchanged) ----
  const GRID = [[5,5],[50,5],[95,5],[5,50],[50,50],[95,50],[5,95],[50,95],[95,95]];
  const CLICKS_PER_POINT = 3;
  let calibIndex=0, clickCount=0, calibrated=false;

  function showCalibrationPoint(){
    const [px,py] = GRID[calibIndex];
    const dot = document.createElement('div');
    dot.className = 'calibration-point';
    dot.style.left = (px/100*area.offsetWidth - 9) + 'px';
    dot.style.top  = (py/100*area.offsetHeight - 9) + 'px';
    dot.onclick = e => {
      clickCount++;
      dot.style.transform = `scale(${1 + clickCount/(CLICKS_PER_POINT*5)})`;
      webgazer.recordScreenPosition(e.clientX, e.clientY, 'click');
      if(clickCount >= CLICKS_PER_POINT){
        dot.remove();
        calibIndex++;
        clickCount = 0;
        if(calibIndex < GRID.length) showCalibrationPoint();
        else finishCalibration();
      }
    };
    area.appendChild(dot);
  }

  function startCalibration(){
    calibIndex = 0; clickCount = 0; calibrated = false;
    area.querySelectorAll('.calibration-point').forEach(n=>n.remove());
    emaX = emaY = null;
    lastId = null;
    gazeDot.style.display = gazeDotEMA.style.display = 'none';
    if(CLICKS_PER_POINT===0) finishCalibration();
    else showCalibrationPoint();
  }

  function finishCalibration(){
    calibrated = true;
    alert('Calibration complete!');
    startTracking();
  }

  calBtn.onclick = startCalibration;

  // ---- Gaze Listener ----
  webgazer
    .setGazeListener((data,ts) => {
      if(!data) return;
      const lx = data.x - areaRect.left;
      const ly = data.y - areaRect.top;
      if(lx<0||ly<0||lx>canvas.width||ly>canvas.height) return;

      if(emaX===null){
        emaX = lx; emaY = ly;
      } else {
        emaX = ALPHA*lx + (1-ALPHA)*emaX;
        emaY = ALPHA*ly + (1-ALPHA)*emaY;
      }

      gazeDot.style.left = lx + 'px';
      gazeDot.style.top  = ly + 'px';
      gazeDotEMA.style.left = emaX + 'px';
      gazeDotEMA.style.top  = emaY + 'px';
      gazeDot.style.display = gazeDotEMA.style.display = 'block';

      highlightAt(emaX, emaY);
    })
    .saveDataAcrossSessions(false)
    .showVideo(false)
    .showFaceOverlay(false)
    .showFaceFeedbackBox(false)
    .applyKalmanFilter(true)
    .showPredictionPoints(false)
    .begin()
    ;

  // Auto-start calibration
  startCalibration();
  </script>
</body>
</html>
